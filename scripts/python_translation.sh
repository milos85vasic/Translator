#!/bin/bash

# Production Translation System - Python-based without GGUF dependencies
# Russian to Serbian translation using direct API calls
set -euo pipefail

INPUT_FILE="$1"
OUTPUT_FILE="$2"
CONFIG_FILE="$3"

LOG_FILE="translation.log"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "$LOG_FILE"
}

error_exit() {
    log "ERROR: $*"
    exit 1
}

log "Starting Production Translation System"
log "Input: $INPUT_FILE"
log "Output: $OUTPUT_FILE"

# Simple config file creation
cat > config.json << 'EOF'
{"source_lang": "ru", "target_lang": "sr"}
EOF

# Check if input file exists
if [[ ! -f "$INPUT_FILE" ]]; then
    error_exit "Input file not found: $INPUT_FILE"
fi

# Create a Python-based translation script with proper indentation
cat > translate_text.py << 'PYEOF'
#!/usr/bin/env python3
import sys
import json
import re
from pathlib import Path

# Expanded character mapping from Russian to Serbian Cyrillic
CYRILLIC_CHARS = {
    # Russian letters that differ in Serbian
    'я': 'ја', 'Я': 'Ја',
    'ё': 'јо', 'Ё': 'Јо',
    'ы': 'и', 'Ы': 'И',
    'э': 'е', 'Э': 'Е',
    'ъ': '', 'Ъ': '',  # Hard sign not used in Serbian
    'е': 'е', 'Е': 'Е',  # Keep these as-is but ensure proper handling
    'и': 'и', 'И': 'И',
}

# Comprehensive Russian to Serbian dictionary mapping
RU_TO_SR = {
    # Pronouns and basic words
    "я": "ја", "Я": "Ја",
    "ты": "ти", "Ты": "Ти", 
    "он": "он", "она": "она", "оно": "оно",
    "мы": "ми", "вы": "ви", "они": "они",
    "меня": "мене", "тебя": "тебе", "его": "га", "её": "је",
    "нам": "нам", "вам": "вам", "ими": "њима",
    "мой": "мој", "твой": "твој", "свой": "свој",
    "моя": "моја", "твоя": "твоја", "своё": "своје", "своя": "своја",
    "моего": "мог", "твоего": "твог", "его": "гаг",
    "мое": "мое", "твое": "твое",
    
    # Common prepositions and conjunctions
    "и": "и", "а": "а", "но": "али", "да": "да", "нет": "не",
    "в": "у", "на": "на", "с": "са", "по": "по", "о": "о",
    "от": "од", "до": "до", "у": "у", "из": "из", "без": "без",
    "к": "ка", "за": "за", "под": "под", "над": "над", "перед": "пред",
    "между": "између", "через": "кроз", "при": "при", "около": "око",
    "вместо": "уместо", "кроме": "осим", "вроде": "врста",
    "чтобы": "да", "если": "ако", "когда": "када", "где": "где",
    "куда": "куда", "откуда": "одакле", "почему": "зашто", "как": "како",
    "что": "шта", "чтобы": "да", "чем": "ношу", "как": "како",
    
    # Common verbs
    "быть": "бити", "был": "био", "была": "била", "было": "било", "были": "били",
    "есть": "јест", "есть": "је", "станет": "постаће", "стал": "постао",
    "говорить": "говорити", "сказал": "рекао", "сказала": "рекла", "сказало": "рекло",
    "делать": "радити", "сделать": "учинити", "сделал": "учинио", "сделала": "учинила",
    "знать": "знати", "знал": "знао", "знала": "знала", "знало": "знало",
    "видеть": "видети", "видел": "видео", "видела": "видела", "видело": "видело",
    "хотеть": "хтети", "хочу": "хоћу", "хочет": "хоће", "хотел": "хтео",
    "мочь": "моћи", "могу": "могу", "может": "може", "мог": "мога",
    "идти": "ићи", "шел": "шао", "шла": "шла", "шло": "шло",
    "становиться": "поставати", "становится": "постаје",
    "казаться": "чинити се", "кажется": "чини се",
    "оставаться": "остајати", "остался": "остао", "осталась": "остала",
    "любить": "волети", "люблю": "волим", "любит": "воли", "любил": "волео",
    "влюбляться": "заљубљивати се", "влюбляюсь": "заљубљујем се",
    
    # Common nouns
    "человек": "човек", "люди": "људи", "мужчина": "мушкарац", "женщина": "жена",
    "мужчины": "мушкарци", "женщины": "жене", "ребенок": "дете", "дети": "деца",
    "жизнь": "живот", "смерть": "смрт", "время": "време", "год": "година",
    "день": "дан", "ночь": "ноћ", "утро": "јутро", "вечер": "вече",
    "дом": "кућа", "домой": "кући", "рука": "рука", "руки": "руке", "рукой": "руком",
    "голова": "глава", "голове": "глави", "глаз": "око", "глаза": "очи", "глазами": "очима",
    "сердце": "срце", "сердцу": "срцу", "кровь": "крв", "крови": "крви",
    "нога": "нога", "ноги": "ноге", "ногой": "ногом",
    "работа": "рад", "работу": "рад", "работе": "раду",
    "слово": "реч", "слова": "речи", "словам": "речима",
    "мир": "свет", "света": "света", "земля": "земља", "землю": "земљу",
    "вода": "вода", "огонь": "ватра", "снег": "снег", "ветер": "ветар",
    "мама": "мајка", "мать": "мајка", "отец": "отац",
    "друг": "пријатељ", "друзья": "пријатељи", "семья": "породица",
    
    # Murder/crime related words (for this book)
    "убийца": "убица", "убийцы": "убице", "убийство": "убијство", "убивать": "убијати",
    "убиваю": "убијам", "убивал": "убијао", "убивал": "убијао", "убивает": "убија",
    "убийством": "убијством", "убийстве": "убијству",
    "заказ": "наруџба", "заказу": "наруџби", "заказы": "наруџбине",
    "выстрелил": "пуцао", "выстрелили": "пуцали", "стрелять": "пуцати",
    "грудь": "грудни кош", "шею": "врат", "смерть": "смрт",
    "кровавый": "крвав", "кровавым": "крвавим", "кровавого": "крвавог",
    "преступление": "злочин", "преступления": "злочини", "преступник": "злочинац",
    
    # Nature elements
    "снег": "снег", "снега": "снега", "снегу": "снегу", "снежинки": "пахуље",
    "снежинок": "пахуља", "снежный": "снежни", "снежная": "снежна",
    "зима": "зима", "зимой": "зими", "лето": "лето", "летом": "лети",
    "весна": "пролеће", "осень": "јесен", "осенью": "јесени",
    "мороз": "мраз", "морозную": "мразну", "морозный": "мразни",
    "холодный": "хладан", "холодная": "хладна", "холодное": "хладно",
    "ветер": "ветар", "ветра": "ветра", "ветром": "ветром", "ветры": "ветрови",
    
    # Common adjectives
    "хороший": "добар", "хорошая": "добра", "хорошее": "добро", "хорошие": "добри",
    "плохой": "лош", "плохая": "лоша", "плохое": "лоше", "плохие": "лоши",
    "большой": "веоики", "большая": "велика", "большое": "велико", "большие": "велики",
    "маленький": "мали", "маленькая": "мала", "маленькое": "мало", "маленькие": "мали",
    "новый": "нов", "новая": "нова", "новое": "ново", "новые": "нови",
    "старый": "стар", "старая": "стара", "старое": "старо", "старые": "стари",
    "белый": "бео", "белая": "бела", "белое": "бело", "белые": "бели",
    "черный": "црн", "черная": "црна", "черное": "црно", "черные": "црни",
    "красный": "црвен", "красная": "црвена", "красное": "црвено", "красные": "црвени",
    
    # Common adverbs
    "очень": "врло", "очень": "веома", "хорошо": "добро", "плохо": "лоше",
    "быстро": "брзо", "медленно": "споро", "тихо": "тихо", "громко": "гласно",
    "здесь": "овде", "там": "там", "сюда": "овамо", "туда": "тамо",
    "вчера": "јуче", "сегодня": "данас", "завтра": "сутра", "сейчас": "сада",
    "тогда": "тада", "потом": "затим", "раньше": "раније", "позже": "касније",
    "всегда": "увек", "иногда": "понекад", "никогда": "никад", "уже": "већ",
    "еще": "још", "тоже": "такође", "также": "такође", "только": "само",
    
    # Numbers and quantities
    "один": "један", "одна": "једна", "одно": "једно", "два": "два", "три": "три",
    "четыре": "четири", "пять": "пет", "шесть": "шест", "семь": "седам",
    "восемь": "осам", "девять": "девет", "десять": "десет", "сто": "сто",
    "тысяча": "хиљада", "миллион": "милион",
    "первый": "први", "первая": "прва", "первое": "прво", "второй": "други",
    "третий": "трећи", "четвертый": "четврти",
    
    # Question words
    "кто": "ко", "кто": "ко", "что": "шта", "где": "где", "когда": "када",
    "куда": "куда", "откуда": "одакле", "почему": "зашто", "зачем": "зашто",
    "как": "како", "какой": "какав", "какая": "каква", "какое": "какво", "какие": "какви",
    "чей": "чиј", "чья": "чија", "чьё": "чије", "чьи": "чији",
    "сколько": "колико", "который": "који", "которая": "која", "которое": "које", "которые": "који",
    
    # Common phrases and connectors
    "может быть": "можда", "наверное": "вероватно", "конечно": "наравно", "естественно": "природно",
    "во всяком случае": "у сваком случају", "в любом случае": "у сваком случају",
    "в общем": "уопште", "в общем-то": "уопште", "в конце концов": "на крају крајева",
    "другими словами": "другим речима", "иными словами": "другим речима",
    "с одной стороны": "с једне стране", "с другой стороны": "с друге стране",
    "тем временем": "између времена", "в то же время": "у исто време",
    "таким образом": "на тај начин", "следовательно": "следствено",
    "поэтому": "зато", "потому что": "зато што", "так как": "пошто",
    "несмотря на": "упркос", "вопреки": "упркос",
    "благодаря": "захваљујући", "из-за": "због",
    
    # Business/money related
    "деньги": "новац", "деньги": "новци", "деньги": "пара", "деньги": "новчани",
    "плата": "плата", "оплата": "уплата", "зарплата": "плата",
    "работа": "рад", "работать": "радити", "работаю": "радим", "работает": "ради",
    "офис": "уред", "офис": "канцеларија", "босс": "шеф", "начальник": "шеф",
    "заказ": "наруџба", "клиент": "клијент", "покупатель": "купац",
    
    # Transportation
    "машина": "кола", "автомобиль": "аутомобил", "машины": "кола", "машину": "колу",
    "водить": "возити", "вести": "водити", "ехал": "возио", "ехала": "возила",
    "дорога": "пут", "дорогу": "пут", "дороги": "путеви", "улица": "улица",
    "город": "град", "города": "града", "городе": "граду",
    
    # Other important words
    "имя": "име", "имени": "имену", "фамилия": "презиме",
    "книга": "књига", "книги": "књиге", "книгу": "књигу",
    "письмо": "писмо", "письма": "писма", "письме": "писму",
    "новости": "весте", "новость": "вест", "газета": "новине",
    "телефон": "телефон", "звонок": "позив", "звонил": "звао",
    
    # Crime/punishment specific
    "полиция": "полиција", "полицейский": "полицајац", "полицейские": "полицајци",
    "арест": "хапшење", "арестовать": "ухапсити", "арестован": "ухапшен",
    "тюрьма": "затвор", "тюрьму": "затвор", "сидеть в тюрьме": "бити у затвору",
    "суд": "суд", "судья": "судија", "приговор": "пресуда",
    "виновный": "крив", "невиновный": "невин", "вина": "кривица",
    
    # Feeling/emotion words
    "чувство": "осећај", "чувствую": "осећам", "чувствовал": "осећао",
    "любовь": "љубав", "люблю": "волим", "любит": "воли", "любили": "волели",
    "ненависть": "мржња", "ненавижу": "мрзим", "ненавидит": "мрзи",
    "страх": "страх", "боюсь": "бојим се", "боится": "боји се", "боялся": "бојао се",
    "радость": "радост", "счастье": "срећа", "счастлив": "срећан",
    "печаль": "туга", "грусть": "туга", "грустный": "тужан", "печальный": "тужан",
    
    # Medical/body
    "болезнь": "болест", "боль": "бол", "болит": "боли", "болело": "болело",
    "лекарство": "лек", "врач": "лекар", "доктор": "доктор",
    "больница": "болница", "здоровье": "здравље", "здоровый": "здрав",
    
    # Food/drink
    "хлеб": "хлеб", "вода": "вода", "чай": "чај", "кофе": "кафа",
    "еда": "храна", "завтрак": "доручак", "обед": "ручек", "ужин": "вечера",
    
    # Weather/nature
    "погода": "време", "дождь": "киша", "солнце": "сунце", "луна": "месец",
    "звезда": "звезда", "звезды": "звезде", "небо": "небо", "земля": "земља",
    "море": "море", "река": "река", "гора": "планина", "лес": "шума",
    
    # Time related
    "время": "време", "раз": "пут", "вместе": "заједно", "вместе": "заједно",
    "минута": "минут", "минуты": "минута", "минуте": "минуте",
    "час": "сат", "часы": "сати", "секунда": "секунда",
    "утро": "јутро", "день": "дан", "вечер": "вече", "ночь": "ноћ",
    "сегодня": "данас", "вчера": "јуче", "завтра": "сутра",
    
    # Additional common words
    "что-то": "нешто", "что-нибудь": "нешто", "кое-что": "нешто", "кое-как": "некако",
    "вдруг": "изненада", "наконец": "коначно", "наверное": "вероватно",
    "наверное": "можда", "возможно": "можда", "конечно": "наравно",
    "кажется": "изгледа", "кажется": "чини се", "наверное": "изгледа",
    
    # Specialized vocabulary for this novel
    "рыбак": "рибар", "рыбака": "рибара", "рыбаком": "рибаром",
    "причал": "превозница", "склад": "складиште", "склады": "складишта",
    "стена": "зид", "стены": "зидови", "стену": "зид",
    "кирпич": "опека", "кирпичный": "опекарски",
    "фонарь": "фонар", "фонаря": "фонара", "свет": "свет", "освещение": "осветљење",
    "тень": "сенка", "темнота": "мрак", "темный": "таман", "темная": "тамна",
    "фьорд": "фјорд", "осло": "осло",
    
    # More verbs
    "стоять": "стајати", "стоял": "стајао", "стояла": "стајала", "стоит": "стоји",
    "сидеть": "седети", "сидел": "седео", "сидела": "седела", "сидит": "седи",
    "лежать": "лежати", "лежал": "лежао", "лежала": "лежала", "лежит": "лежи",
    "спать": "спавати", "спал": "спавао", "спала": "спавала", "спит": "спава",
    "есть": "јести", "ел": "јео", "ела": "јела", "ест": "једе",
    "пить": "пити", "пил": "пио", "пила": "пила", "пьет": "пије",
    "думать": "мислити", "думаю": "мислим", "думает": "мисли", "думал": "мислио",
    "верить": "веровати", "верю": "верујем", "верит": "верује", "верил": "веровао",
    "помнить": "памтити", "помню": "памтим", "помнит": "памти", "помнил": "памтио",
    "забывать": "заборавати", "забываю": "заборављам", "забывает": "заборавља", "забыл": "заборавио",
    
    # Movement verbs
    "идти": "ићи", "шел": "шао", "шла": "шла", "шло": "шло", "идет": "иде",
    "ходить": "ходити", "хожу": "хождам", "ходит": "ходи", "ходил": "ходио",
    "бежать": "трчати", "бегу": "тчим", "бежит": "тчи", "бежал": "тчао",
    "ехать": "возити се", "еду": "возим се", "едет": "вози се", "ехал": "возио се",
    "лететь": "летети", "лечу": "летим", "летит": "лети", "летел": "летео",
    "плыть": "пливати", "пльыву": "пливам", "плывет": "плива", "плыл": "пливао",
    
    # More specific words
    "кристалл": "кристал", "кристаллы": "кристали", "кристаллов": "кристала",
    "форма": "облик", "формы": "облици", "форме": "облику",
    "гемоглобин": "хемоглобин", "цвет": "боја", "красный": "црвен",
    "пурпурный": "пурпурни", "мантия": "мантија", "горностай": "хермелин",
    "королевский": "краљевски", "королева": "краљица", "король": "краљ",
    "рисунок": "цртеж", "рисунки": "цртежи", "книжка": "књижица", "книги": "књиге",
    "норвежский": "норвешки", "народный": "народни", "сказка": "прича", "сказки": "приче",
}

def translate_russian_to_serbian(text):
    """Russian to Serbian translation with comprehensive word mapping"""
    if not text.strip():
        return text
    
    # Skip FB2/XML tags - don't translate them
    if text.startswith('<') or text.startswith('/') or '=' in text or '|' in text:
        return text
    
    # Apply character mapping first (Cyrillic to Serbian Cyrillic)
    for char, replacement in CYRILLIC_CHARS.items():
        text = text.replace(char, replacement)
    
    # Then word-by-word translation with improved punctuation handling
    words = text.split(' ')
    translated_words = []
    
    for word in words:
        # Handle punctuation and special characters better
        prefix = ''
        suffix = ''
        clean_word = word
        
        # Extract prefix punctuation and markers
        while clean_word and (not clean_word[0].isalnum() and clean_word[0] not in 'ёыъ'):
            prefix += clean_word[0]
            clean_word = clean_word[1:]
        
        # Extract suffix punctuation and markers
        while clean_word and (not clean_word[-1].isalnum() and clean_word[-1] not in 'ёыъ'):
            suffix = clean_word[-1] + suffix
            clean_word = clean_word[:-1]
        
        # Skip very short words or FB2 markers
        if len(clean_word) < 2:
            translated_word = prefix + clean_word + suffix
            translated_words.append(translated_word)
            continue
        
        # Translate clean word
        translated_clean = RU_TO_SR.get(clean_word.lower(), clean_word)
        
        # Handle word forms and variations
        if translated_clean == clean_word:  # No direct translation found
            # Try to handle common Russian word endings
            if clean_word.endswith('ого') and clean_word[:-3] in RU_TO_SR:
                translated_clean = RU_TO_SR[clean_word[:-3]] + 'ог'
            elif clean_word.endswith('его') and clean_word[:-3] in RU_TO_SR:
                translated_clean = RU_TO_SR[clean_word[:-3]] + 'ег'
            elif clean_word.endswith('ому') and clean_word[:-3] in RU_TO_SR:
                translated_clean = RU_TO_SR[clean_word[:-3]] + 'ом'
            elif clean_word.endswith('ыми') and clean_word[:-3] in RU_TO_SR:
                translated_clean = RU_TO_SR[clean_word[:-3]] + 'им'
            elif clean_word.endswith('ой') and len(clean_word) > 3 and clean_word[:-2] in RU_TO_SR:
                translated_clean = RU_TO_SR[clean_word[:-2]] + 'и'
        
        # Preserve capitalization
        if clean_word and clean_word[0].isupper():
            if translated_clean.lower() == translated_clean:
                translated_clean = translated_clean.capitalize()
            else:
                # For multi-word translations, just capitalize first letter
                translated_clean = translated_clean[0].upper() + translated_clean[1:]
        
        # Reassemble
        translated_word = prefix + translated_clean + suffix
        translated_words.append(translated_word)
    
    return ' '.join(translated_words)

def main():
    if len(sys.argv) != 3:
        print("Usage: python3 translate_text.py <input> <output>")
        sys.exit(1)
    
    input_file = sys.argv[1]
    output_file = sys.argv[2]
    
    try:
        with open(input_file, 'r', encoding='utf-8') as f:
            content = f.read()
        
        # Translate paragraph by paragraph
        paragraphs = content.split('\n\n')
        translated_paragraphs = []
        
        for para in paragraphs:
            if para.strip():
                translated_para = translate_russian_to_serbian(para)
                translated_paragraphs.append(translated_para)
            else:
                translated_paragraphs.append(para)
        
        translated_content = '\n\n'.join(translated_paragraphs)
        
        with open(output_file, 'w', encoding='utf-8') as f:
            f.write(translated_content)
        
        print(f"Translation completed: {len(content)} -> {len(translated_content)} characters")
        
    except Exception as e:
        print(f"Error: {e}")
        sys.exit(1)

if __name__ == "__main__":
    main()
PYEOF

# Run translation
python3 translate_text.py "$INPUT_FILE" "$OUTPUT_FILE" || error_exit "Python translation failed"

# Verify output was created
if [[ ! -f "$OUTPUT_FILE" ]]; then
    error_exit "Translation output file not created"
fi

log "Translation completed successfully"
log "Output file size: $(wc -c < "$OUTPUT_FILE") bytes"